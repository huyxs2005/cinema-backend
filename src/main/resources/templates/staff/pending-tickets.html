<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>�?ơn chờ xử lý - Cinema HUB Staff</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/styles.css}">
    <link rel="stylesheet" th:href="@{/staff/staff-ui.css}">
</head>
<body class="staff-theme page-surface">
<th:block th:replace="~{fragments/header :: main}"></th:block>

<main class="content-shell staff-shell">
    <section class="staff-container ticket-board" id="pendingTicketsRoot"
             th:attr="data-base-endpoint=@{/api/staff/bookings}">
        <section class="staff-hero">
            <div>
                <p class="staff-eyebrow">Vé đang chờ</p>
                <h1>�?�ơn cần xác minh</h1>
                <p>Danh sách vé đã tạo tại quầy nhưng chưa đánh dấu hoàn tất thanh toán.</p>
            </div>
            <div class="staff-hero__actions">
                <a class="btn btn-outline-light" th:href="@{/staff/sold-tickets}">Về danh sách đã bán</a>
            </div>
        </section>

        <div class="staff-alert" th:if="${param.success}">
            Booking <strong th:text="${param.success}">BK-000000</strong> đã xác minh thành công.
        </div>
        <div class="staff-alert error" th:if="${param.error}">
            KHÔNG THỂ xử lý booking <strong th:text="${param.error}">BK-000000</strong>. Vui lòng thử lại.
        </div>

        <div th:if="${#lists.isEmpty(bookings)}" class="staff-empty-hint">
            Hiện chưa có vé nào đang chờ xác minh.
        </div>

        <div class="ticket-card-grid" th:if="${!#lists.isEmpty(bookings)}">
            <article class="ticket-card"
                     th:each="booking : ${bookings}"
                     th:classappend="${booking.bookingId == focusBookingId} ? ' ticket-card--highlight'">
                <div class="ticket-card__head">
                    <div>
                        <p class="ticket-code" th:text="${booking.bookingCode}">BK-000000</p>
                        <p class="ticket-meta"
                           th:text="'Thanh toán: ' + (${booking.paymentMethod} ?: '---')">Tiền mặt</p>
                        <p class="ticket-meta ticket-meta--muted"
                           th:text="'Tạo lúc: ' + ${#temporals.format(booking.createdAt, 'HH:mm dd/MM/yyyy')}">
                            09:15 01/01/2025
                        </p>
                    </div>
                    <div class="ticket-actions">
                        <button class="btn btn-success btn-sm"
                                data-action="verify"
                                th:data-booking-id="${booking.bookingId}">
                            Xác minh
                        </button>
                        <button class="btn btn-outline-light btn-sm"
                                data-action="cancel"
                                th:data-booking-id="${booking.bookingId}">
                            Huỷ
                        </button>
                    </div>
                </div>
                <div class="ticket-card__body">
                    <p class="ticket-movie" th:text="${booking.movieTitle}">Tên phim</p>
                    <p class="ticket-room" th:text="'Phòng ' + ${booking.auditoriumName}">Phòng 1</p>
                    <p class="ticket-field">
                        <span>Suất:</span>
                        <strong th:text="${#temporals.format(booking.showtimeStart, 'HH:mm dd/MM/yyyy')}">
                            12:00 01/01/2025
                        </strong>
                    </p>
                    <p class="ticket-field">
                        <span>Ghế:</span>
                        <strong th:text="${#strings.listJoin(booking.seats.![seatLabel], ', ')}">A1, A2</strong>
                    </p>
                    <p class="ticket-field">
                        <span>Tổng tiền:</span>
                        <strong th:text="${#numbers.formatDecimal(booking.finalAmount != null ? booking.finalAmount : booking.totalAmount, 0, 'COMMA', 0, 'POINT') + ' ₫'}">
                            0 ₫
                        </strong>
                    </p>
                    <p class="ticket-field">
                        <span>Email:</span>
                        <strong th:text="${booking.customerEmail ?: '---'}">---</strong>
                    </p>
                    <p class="ticket-field">
                        <span>Điện thoại:</span>
                        <strong th:text="${booking.customerPhone ?: '---'}">---</strong>
                    </p>
                </div>
            </article>
        </div>

        <div class="staff-toast" id="staffTicketsToast" role="status"></div>
    </section>
</main>

<div class="modal fade" id="ticketInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content staff-modal">
            <div class="modal-header">
                <div>
                    <p class="ticket-meta">Mã vé</p>
                    <h5 class="modal-title" id="ticketModalBookingCode">BK-000000</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="ticket-modal-grid">
                    <div class="ticket-modal-preview">
                        <img id="ticketQrCode" src="" alt="QR code" class="ticket-modal-qr">
                        <button type="button" class="btn btn-outline-light w-100 mt-3" id="printTicketBtn">
                            In vé PDF
                        </button>
                    </div>
                    <div class="ticket-modal-details">
                        <p><span>Mã:</span> <strong id="ticketBookingCode">BK-000000</strong></p>
                        <p><span>Phim:</span> <strong id="ticketModalMovie">Tên phim</strong></p>
                        <p><span>Phòng:</span> <strong id="ticketModalAuditorium">Phòng 1</strong></p>
                        <p><span>Suất:</span> <strong id="ticketModalShowtime">19:30 01/01/2025</strong></p>
                        <p><span>Ghế:</span> <strong id="ticketModalSeats">A1, A2</strong></p>
                        <p><span>Khách:</span> <strong id="ticketModalCustomer">---</strong></p>
                        <p><span>Email:</span> <strong id="ticketModalEmail">---</strong></p>
                        <p><span>Thanh toán:</span> <span id="ticketModalPaymentStatus" class="badge bg-warning">---</span></p>
                        <p><span>Check-in:</span> <span id="ticketModalCheckInStatus" class="badge bg-secondary">---</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{fragments/footer :: main}"></th:block>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script th:src="@{/auth.js}"></script>
<script th:src="@{/staff/staff-tickets.js}"></script>
</body>
</html>
