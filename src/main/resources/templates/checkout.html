<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán VietQR - Cinema HUB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<th:block th:replace="~{fragments/header :: main}"></th:block>
<main class="content-shell checkout-page">
    <div class="content-container">
        <section th:if="${checkout != null}"
                 id="checkoutRoot"
                 class="checkout-grid"
                 th:attr="data-hold-token=${checkout?.holdToken},
                          data-booking-id=${checkout?.bookingId},
                          data-booking-code=${checkout?.bookingCode},
                          data-showtime-id=${checkout?.showtime?.id},
                          data-user-email=${currentUserEmail},
                          data-expires-at=${checkout?.expiresAt},
                          data-movie-id=${checkout?.showtime?.movieId}"
                 th:data-seat-ids-json="|[[${checkout?.seatIds}]]|">
            <div class="checkout-summary-card">
                <p class="eyebrow">Bước 1</p>
                <h1>Kiểm tra thông tin vé</h1>
                <div class="checkout-summary-meta">
                    <p><strong th:text="${checkout?.showtime?.movieTitle}">Tên phim</strong></p>
                    <p>
                        <span th:text="${checkout?.showtime?.auditoriumName}">Phòng chiếu</span>
                        &middot;
                        <span th:text="${checkout?.showtime?.startTime != null ? #temporals.format(checkout.showtime.startTime, 'EEEE, dd/MM - HH:mm') : ''}">20:00</span>
                    </p>
                </div>
                <ul class="checkout-seat-list">
                    <li th:each="seat : ${checkout != null ? checkout.seats : {}}">
                        <span th:text="${seat.label}">A1</span>
                        <span th:text="${seat.price != null ? #numbers.formatDecimal(seat.price, 0, 0) + ' ₫' : '0 ₫'}">120.000 ₫</span>
                    </li>
                </ul>
                <div class="checkout-total-line">
                    <span>Tổng cộng</span>
                    <strong th:text="${checkout != null ? #numbers.formatDecimal(checkout.total, 0, 0) + ' ₫' : '0 ₫'}">0 ₫</strong>
                </div>
                <a class="btn btn-text"
                   th:href="@{/movies/{id}(id=${checkout?.showtime?.movieId})}"
                   th:if="${checkout?.showtime?.movieId != null}">
                    &larr; Chọn lại suất chiếu
                </a>
            </div>
            <div class="checkout-payment-card" id="checkoutPayosPanel">
                <p class="eyebrow text-light">Bước 2</p>
                <h2 class="text-light">Thanh toán VietQR</h2>
                <p class="text-light">
                    Chúng tôi sẽ phát hành vé điện tử ngay khi giao dịch được PayOS xác nhận thành công.
                </p>
                <div class="payos-qr" id="payosQrContainer" hidden>
                    <img id="payosQrImage" alt="Mã VietQR" src="">
                    <div class="payos-qr__meta">
                        <p class="text-light">Mã đơn: <strong id="payosOrderCode">---</strong></p>
                        <p class="text-light" id="payosBankLine">MB Bank - 0931630902 - DAO NAM HAI</p>
                        <p class="text-light">Số tiền: <strong id="payosAmount">0 ₫</strong></p>
                        <p class="text-light">Nội dung: <strong id="payosDescription"></strong></p>
                        <p class="text-light" id="payosCountdown">QR có hiệu lực: --:--</p>
                        <button class="btn btn-text" type="button" id="regenerateQrButton">Tạo QR mới</button>
                    </div>
                </div>
                <p class="text-light form-grid__full">
                    PayOS xác thực chuyển khoản qua webhook tại <code>/api/payment/webhook</code>.
                    Vui lòng giữ trang này mở đến khi hệ thống điều hướng sang trang xác nhận.
                </p>
                <p class="warning-text form-grid__full" id="payosError" hidden></p>
                <div class="checkout-actions">
                    <button class="btn checkout-back-button" type="button" id="checkoutBackButton">
                        &larr; Chọn ghế khác
                    </button>
                </div>
            </div>
        </section>
        <section class="checkout-empty" th:if="${checkout == null}">
            <h1>Không tìm thấy phiên thanh toán</h1>
            <p th:text="${checkoutError != null ? checkoutError : 'Phiên giữ ghế đã hết hạn hoặc không tồn tại. Vui lòng chọn ghế lại từ đầu.'}">
                Phiên giữ ghế đã hết hạn hoặc không tồn tại. Vui lòng chọn ghế lại từ đầu.
            </p>
            <p th:if="${checkoutToken != null}" class="muted">
                Token: <code th:text="${checkoutToken}">token</code>
            </p>
            <div class="checkout-actions">
                <a class="btn btn-primary"
                   th:if="${fallbackShowtimeId != null}"
                   th:href="@{/movies/{id}(id=${fallbackShowtimeId})}">
                    Quay lại chọn ghế
                </a>
                <a class="btn btn-outline" th:href="@{/}">
                    Về trang chủ
                </a>
            </div>
        </section>
    </div>
</main>
<th:block th:replace="~{fragments/footer :: main}"></th:block>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/auth.js}"></script>
<script th:src="@{/checkout-page.js}"></script>
</body>
</html>
